<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PRAN — Order Ringkas | Kopusamaju</title>

  <!-- Bootstrap & Icon -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background:#fff; padding-bottom:60px; }
    .prod-card { border-radius:12px; transition:transform .15s; }
    .prod-card:hover { transform:translateY(-4px); box-shadow:0 10px 25px rgba(0,0,0,0.05); }
    .qr-box { border:1px solid #eee; border-radius:12px; padding:16px; background:#fff; }
    .disabled-link { opacity:0.6; pointer-events:none; }
    .required { color:#c00; }
    footer { text-align:center; color:#777; padding-top:1rem; border-top:1px solid #eee; margin-top:3rem; }
  </style>
</head>
<body>

  <div class="container py-4">
    <h3 class="mb-4 text-danger fw-bold text-center">Tempahan Produk PRAN — Kopusamaju Sabah Berhad</h3>

    <div class="row g-4">
      <!-- Produk -->
      <div class="col-lg-8">
        <div id="products-grid" class="row g-3"></div>

        <!-- Borang -->
        <div class="mt-4 qr-box">
          <h5 class="mb-3">Langkah Pembayaran</h5>
          <p>Sila scan QR DuitNow atau pindahkan ke akaun:</p>
          <p><strong>Maybank: 560072624185</strong><br>Koperasi Pembangunan Usahasama Masyarakat Maju Sabah Berhad</p>
          <img id="qr-img" src="https://via.placeholder.com/260x260.png?text=QR+DuitNow" class="mb-3" width="200" alt="QR DuitNow">

          <div><strong>Jumlah perlu dibayar:</strong> <span id="checkout-total" class="text-danger fw-bold">RM0.00</span></div>

          <div class="mt-3">
            <label class="form-label">Nama <span class="required">*</span></label>
            <input id="cust-name" class="form-control" placeholder="Nama penuh">
          </div>
          <div class="mt-2">
            <label class="form-label">No. Telefon <span class="required">*</span></label>
            <input id="cust-phone" class="form-control" placeholder="6012xxxxxxx">
          </div>
          <div class="mt-2">
            <label class="form-label">Muat Naik Resit (gambar) <span class="required">*</span></label>
            <input id="receipt-file" type="file" accept="image/*" class="form-control">
          </div>

          <div class="mt-4 d-flex gap-2 flex-wrap">
            <button id="submit-order" class="btn btn-success">
              <i class="bi bi-check-circle me-1"></i> Submit Order
            </button>
            <button id="whatsapp-order" class="btn btn-outline-success disabled-link" disabled>
              <i class="bi bi-whatsapp me-1"></i> Hantar ke WhatsApp
            </button>
            <span id="submit-status" class="ms-2 small text-muted align-self-center"></span>
          </div>
        </div>
      </div>

      <!-- Troli -->
      <div class="col-lg-4">
        <div class="p-3 border rounded-3 bg-white shadow-sm">
          <h5>Troli Anda</h5>
          <div id="cart-items" class="small text-muted mb-2">Tiada item dipilih.</div>
          <div class="d-flex justify-content-between">
            <strong>Total:</strong>
            <strong id="cart-total">RM0.00</strong>
          </div>
          <button id="clear-cart" class="btn btn-sm btn-outline-secondary w-100 mt-3">Kosongkan</button>
        </div>
      </div>
    </div>
  </div>

  <footer>© <span id="year"></span> Kopusamaju Sabah Berhad</footer>

  <script>
    const APPS_PROXY_SUBMIT = "https://pran-proxy.onrender.com/submit";
    const SECRET_TOKEN = "PRAN-SECURE-9b8e47a2e37b4fd1b32b93dfc5eaa9b7";
    const OWNER_WHATSAPP = "60128169367";

    const PRODUCTS = [
      { id:"jus", name:"Jus Mangga", price:5.00 },
      { id:"wafer", name:"Wafer Coklat", price:3.00 },
      { id:"minuman", name:"Minuman Kotak", price:4.00 },
    ];

    const cart = {};
    function formatRM(v){return "RM"+v.toFixed(2);}
    function updateCartUI(){
      let html="",total=0;
      PRODUCTS.forEach(p=>{
        const q=cart[p.id]||0;
        if(q>0){html+=`<div>${p.name} x ${q} — ${formatRM(p.price*q)}</div>`;total+=p.price*q;}
      });
      document.getElementById("cart-items").innerHTML=html||"Tiada item dipilih.";
      document.getElementById("cart-total").textContent=formatRM(total);
      document.getElementById("checkout-total").textContent=formatRM(total);
    }

    const grid=document.getElementById("products-grid");
    PRODUCTS.forEach(p=>{
      const col=document.createElement("div");
      col.className="col-md-6";
      col.innerHTML=`<div class="p-3 prod-card border">
        <div class="fw-bold">${p.name}</div>
        <div class="text-muted small mb-2">${formatRM(p.price)}</div>
        <div class="d-flex align-items-center gap-2">
          <button class="btn btn-sm btn-outline-secondary minus" data-id="${p.id}">-</button>
          <span id="qty-${p.id}" class="mx-2">0</span>
          <button class="btn btn-sm btn-outline-secondary plus" data-id="${p.id}">+</button>
        </div>
      </div>`;
      grid.appendChild(col);
    });

    document.addEventListener("click",(e)=>{
      if(e.target.classList.contains("plus")){
        const id=e.target.dataset.id;cart[id]=(cart[id]||0)+1;document.getElementById(`qty-${id}`).textContent=cart[id];updateCartUI();
      }else if(e.target.classList.contains("minus")){
        const id=e.target.dataset.id;cart[id]=Math.max(0,(cart[id]||0)-1);document.getElementById(`qty-${id}`).textContent=cart[id];updateCartUI();
      }
    });

    document.getElementById("clear-cart").onclick=()=>{PRODUCTS.forEach(p=>cart[p.id]=0);updateCartUI();};
    updateCartUI();

    const submitBtn=document.getElementById("submit-order");
    const whatsappBtn=document.getElementById("whatsapp-order");
    const statusEl=document.getElementById("submit-status");

    function disableWhatsApp(disabled){
      whatsappBtn.disabled=disabled;
      whatsappBtn.classList.toggle("disabled-link",disabled);
    }

    disableWhatsApp(true);
    let lastSubmittedData=null;

    submitBtn.onclick=async ()=>{
      const name=document.getElementById("cust-name").value.trim();
      const phone=document.getElementById("cust-phone").value.trim();
      const file=document.getElementById("receipt-file").files[0];
      const selected=PRODUCTS.map(p=>({p,qty:cart[p.id]||0})).filter(x=>x.qty>0);
      if(selected.length===0) return alert("Sila pilih produk dahulu.");
      if(!name||!phone||!file) return alert("Sila isi semua maklumat wajib.");
      const base64=await fileToBase64(file);

      const items=selected.map(x=>({id:x.p.id,name:x.p.name,qty:x.qty,price:x.p.price,subtotal:x.p.price*x.qty}));
      const total=items.reduce((a,b)=>a+b.subtotal,0);
      const payload={secret:SECRET_TOKEN,timestamp:new Date().toISOString(),customer:{name,phone},items,total,receiptName:file.name,receiptBase64:base64};

      statusEl.textContent="Menghantar...";
      try{
        const res=await fetch(APPS_PROXY_SUBMIT,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
        const data=await res.json();
        if(data.status==="success"){
          statusEl.textContent="✅ Berjaya hantar ("+(data.ref||"Ref")+")";
          disableWhatsApp(false);
          lastSubmittedData={items,total,name,phone,ref:data.ref};
        }else throw new Error(data.message||"Server error");
      }catch(err){
        console.error(err);
        alert("❌ Gagal menghantar ke server: "+err.message);
        statusEl.textContent="";
      }
    };

    whatsappBtn.onclick=()=>{
      if(!lastSubmittedData) return alert("Tiada data order untuk dihantar.");
      const d=lastSubmittedData;
      const msg=`Pesanan Baru (Ref: ${d.ref||""})\n`+
        d.items.map(i=>`${i.name} x${i.qty} = RM${i.subtotal.toFixed(2)}`).join("\n")+
        `\nTotal: RM${d.total.toFixed(2)}\nNama: ${d.name}\nTel: ${d.phone}`;
      window.open(`https://wa.me/${OWNER_WHATSAPP}?text=${encodeURIComponent(msg)}`,"_blank");
    };

    function fileToBase64(f){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(f);});}
    document.getElementById("year").textContent=new Date().getFullYear();
  </script>
</body>
</html>
